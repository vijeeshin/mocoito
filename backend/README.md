# mocoito

This project was generated by [Hypergraph](https://mocoito.in)

## Get Started

Using npm:

```sh
npm install @hgraph/cli -g
```

## Prerequisites

To run this project follow these steps:

### Step 1: Install Docker Desktop

Install [Docker Desktop](https://www.docker.com/products/docker-desktop/) to get started

### Step 2: Install skaffold

We use skaffold to build and deploy services which supports micro-services in monorepos - a great
tool. Install skaffold using one of these commands:

```sh
# For macOS on x86_64 (amd64)
curl -Lo skaffold https://storage.googleapis.com/skaffold/releases/latest/skaffold-darwin-amd64 && \
sudo install skaffold /usr/local/bin/

# For macOS on ARMv8 (arm64)
curl -Lo skaffold https://storage.googleapis.com/skaffold/releases/latest/skaffold-darwin-arm64 && \
sudo install skaffold /usr/local/bin/
```

Check [this document](https://skaffold.dev/docs/install/) for additional details

## Setup a Project

```sh
# login first
hypergraph auth login

# create a project
hypergraph project create --checkout --open

# install dependencies
yarn install

# save all the files
hypergraph save "**/*.hg.ts"
```

## Setup Firebase Project

### Step 1:

Create a firebase project from [Firebase Console](https://console.firebase.google.com)

### Step 2:

Update project id [services/api-service/.firebaserc](services/api-service/.firebaserc)

```json
{
  "projects": {
    "default": "<<PROJECT ID>>"
  }
}
```

### Step 3:

Create a service account and create key.json from
[Google Cloud Console](https://console.cloud.google.com/iam-admin/serviceaccounts)

Select Project → Click on service account → Keys → Add Key → Create New → JSON

### Step 4:

Copy json file as `services/api-service/firebase-service-account.json`
[open it](services/api-service/firebase-service-account.json)

### Step 5: Create firestore database

Create firestore database from [Firestore console](https://console.firebase.google.com/u/0/project)

## Start the server

```sh
yarn start
```

## Testing

API endpoint will be available at: [http://localhost:4001/graphql](http://localhost:4001/graphql)

### Create a user

Use the following curl command create a user

```sh
curl 'http://127.0.0.1:4001/graphql' \
  -H 'Accept-Encoding: gzip, deflate, br' -H 'Content-Type: application/json' -H 'Accept: application/json'  \
  --data-binary '{
    "query": "mutation createUser($input: CreateUserInput!) { createUser(input: $input) { id name email status } }",
    "variables": { "input": { "name": "John Doe", "email": "test@gmail.com", "password": "test@123" } }
  }' --compressed \
  | node -e "console.log(JSON.parse(require('fs').readFileSync('/dev/stdin', 'utf-8')))"
```

### Sign in

Sign in using the following command

```sh
export TOKEN=$(
  curl 'http://127.0.0.1:4001/graphql' \
    -H 'Accept-Encoding: gzip, deflate, br' -H 'Content-Type: application/json' -H 'Accept: application/json'  \
    --data-binary '{
      "query": "mutation signInUser($email: String!, $password: String!) { signInUser(email: $email, password: $password) { accessToken refreshToken } }",
      "variables": { "email": "test@gmail.com", "password": "test@123" }
    }' --compressed \
  | node -e "console.log(JSON.parse(require('fs').readFileSync('/dev/stdin', 'utf-8'))?.data?.signInUser?.accessToken)"
); echo $TOKEN
```

### Fetch current user

Use access token to fetch current user

```sh
curl 'http://127.0.0.1:4001/graphql' \
  -H 'Accept-Encoding: gzip, deflate, br' -H 'Content-Type: application/json' -H 'Accept: application/json'  \
  -H "Authorization: Bearer $TOKEN" \
  --data-binary '{ "query": "query me { me { id name email status } }" }' --compressed \
  | node -e "console.log(JSON.parse(require('fs').readFileSync('/dev/stdin', 'utf-8')))"
```
